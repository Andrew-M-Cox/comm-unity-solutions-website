<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Authenticating...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .message {
      text-align: center;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="message">
    <p>Completing authentication...</p>
  </div>
  <script>
    (function() {
      // Parse the URL for the authorization code or token
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const token = params.get('token');
      
      console.log('Callback page loaded', { code, token });
      
      if (token) {
        // If we have a token, send it directly
        const data = {
          token: token,
          provider: 'github'
        };
        
        const message = "authorization:github:success:" + JSON.stringify(data);
        
        if (window.opener) {
          window.opener.postMessage(message, window.location.origin);
          console.log('Sent message to opener:', message);
        }
        
        setTimeout(function() {
          window.close();
        }, 1000);
      } else if (code) {
        // If we have a code, exchange it for a token
        fetch('/.netlify/functions/auth?code=' + code)
          .then(function(response) {
            return response.text();
          })
          .then(function(html) {
            // The HTML contains the postMessage script
            document.body.innerHTML = html;
          })
          .catch(function(error) {
            console.error('Error exchanging code for token:', error);
            document.querySelector('.message p').textContent = 'Authentication failed. Please close this window and try again.';
          });
      } else {
        console.error('No code or token found in URL');
        document.querySelector('.message p').textContent = 'No authorization code found. Please close this window and try again.';
      }
    })();
  </script>
</body>
</html>

