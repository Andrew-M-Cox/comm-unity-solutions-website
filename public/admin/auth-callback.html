<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Authenticating...</title>
  <!-- OAuth callback handler for Decap CMS -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .message {
      text-align: center;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="message">
    <p>Completing authentication...</p>
  </div>
  <script>
    (function() {
      // Parse the URL for the authorization code or token
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const token = params.get('token');
      
      console.log('Callback page loaded', { code, token });
      
      if (token) {
        console.log('Callback page: Token received, fetching GitHub user info');
        document.querySelector('.message p').textContent = 'Fetching user information...';
        
        // Fetch GitHub user info using the token
        fetch('https://api.github.com/user', {
          headers: {
            'Authorization': 'token ' + token,
            'Accept': 'application/json'
          }
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to fetch user info: ' + response.status);
          }
          return response.json();
        })
        .then(function(user) {
          console.log('Callback page: User info received', user);
          
          // Store in Decap CMS format with full user object
          const userData = {
            token: token,
            backendName: 'github',
            login: user.login,
            name: user.name,
            avatar_url: user.avatar_url,
            email: user.email
          };
          
          localStorage.setItem('netlify-cms-user', JSON.stringify(userData));
          console.log('Callback page: User data stored in localStorage', userData);
          
          document.querySelector('.message p').textContent = 'Authentication successful! Redirecting...';
          
          // Reload the opener window to trigger Decap CMS to check for the token
          if (window.opener) {
            window.opener.location.reload();
            
            setTimeout(function() {
              console.log('Callback page: Closing window');
              window.close();
            }, 1000);
          } else {
            console.error('Callback page: No window.opener found!');
            document.querySelector('.message p').textContent = 'Error: Unable to communicate with main window.';
          }
        })
        .catch(function(error) {
          console.error('Callback page: Error fetching user info', error);
          document.querySelector('.message p').textContent = 'Error: ' + error.message;
        });
      } else if (code) {
        // If we have a code, exchange it for a token
        fetch('/.netlify/functions/auth?code=' + code)
          .then(function(response) {
            return response.text();
          })
          .then(function(html) {
            // The HTML contains the postMessage script
            document.body.innerHTML = html;
          })
          .catch(function(error) {
            console.error('Error exchanging code for token:', error);
            document.querySelector('.message p').textContent = 'Authentication failed. Please close this window and try again.';
          });
      } else {
        console.error('No code or token found in URL');
        document.querySelector('.message p').textContent = 'No authorization code found. Please close this window and try again.';
      }
    })();
  </script>
</body>
</html>

